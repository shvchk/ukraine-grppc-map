<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title>Ukraine gross region product per capita distribution</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.2/leaflet.css" />
  <style>
  body { margin: 0; padding: 0; }
  .leaflet-container { background: #fff; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  </style>
</head>
<body>
  <div id='map'></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.2/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.1.0/topojson.min.js"></script>
  <script>
  var regionsDataUri = "regionsData.json";
  var regionsCoordinatesUri = "regionsCoordinates.topojson";
  var initialCoordinates = [48.47, 31.39];
  var intialScale = 6;

  var regionsData = {};
  var regionsCoordinates = {};

  loadJSON(regionsDataUri, function(s) {
    regionsData = JSON.parse(s);
    dataLoad();
  });

  loadJSON(regionsCoordinatesUri, function(s) {
    regionsCoordinates = JSON.parse(s);
    regionsCoordinates = topojson.feature(regionsCoordinates, regionsCoordinates.objects.regionsCoordinates);
    dataLoad();
  });

  function dataLoad() {
    if (Object.keys(regionsData).length !== 0
      && Object.keys(regionsCoordinates).length !== 0) {

      var grp = [];
      for (var region in regionsData) {
        grp.push(regionsData[region].grp);
      }

      grp.sort(function (a, b) { return a - b });

      var grpMin = grp[0];
      var grpMax = grp[grp.length - 1];
      var grpMedian = median(grp);

      function style(feature) {
        var regionId = feature.properties.iso_3166_2;
        var region = regionsData[regionId];
        var fillOpacity = region.grp / grpMax;

        return {
          fillColor: '#000',
          weight: 1,
          opacity: .2,
          color: '#000',
          fillOpacity: fillOpacity
        };
      }

      var map = L.map('map').setView(initialCoordinates, intialScale);
      L.geoJson(regionsCoordinates, { style: style }).addTo(map);
    }
  }

  function loadJSON(uri, callback) {
    var xobj = new XMLHttpRequest();
    xobj.overrideMimeType("application/json");
    xobj.open('GET', uri, true);
    xobj.send(null);

    xobj.onreadystatechange = function () {
      if (xobj.readyState == 4) { //  && xobj.status == "200"
        callback(xobj.responseText);
      }
    };
  }

  function median(arr) {
    if (arr.length == 0) {
      return null
    }

    arr.sort(function (a, b) { return a - b });
    var mid = Math.floor(arr.length / 2);

    if ((arr.length % 2) == 1) { // length is odd
      return arr[mid];
    } else {
      return (arr[mid - 1] + arr[mid]) / 2;
    }
  }
  </script>
</body>
</html>
